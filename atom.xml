<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>乱序的博客</title>
  
  <subtitle>LuanXu&#39;s Blog</subtitle>
  <link href="https://luanxu.me/atom.xml" rel="self"/>
  
  <link href="https://luanxu.me/"/>
  <updated>2021-10-09T02:15:21.623Z</updated>
  <id>https://luanxu.me/</id>
  
  <author>
    <name>LuanXu</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>SPA重新构建部署如何刷新缓存</title>
    <link href="https://luanxu.me/posts/3130060804/"/>
    <id>https://luanxu.me/posts/3130060804/</id>
    <published>2021-10-08T01:55:09.000Z</published>
    <updated>2021-10-09T02:15:21.623Z</updated>
    
    <content type="html"><![CDATA[<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><div class="story post-story"><p>单页面应用在重新部署更新时，此时正在浏览网页，并且已经在网页内的用户，始终会使用老的js与css文件，一直在使用已经缓存了的静态资源。</p><span id="more"></span></div><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><div class="story post-story"><p>在HTTP协议中，响应头有 <code>expires</code> 或 <code>Cache-Control:max-age=XXX</code>， 前端才缓存。<br>但在浏览器中，默认会对html,js,css,字体,音视频等静态文件、以及重定向进行缓存，如果在HEAD标签中指定：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">HEAD</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">META</span> <span class="attr">HTTP-EQUIV</span>=<span class="string">&quot;Pragma&quot;</span> <span class="attr">CONTENT</span>=<span class="string">&quot;no-cache&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">META</span> <span class="attr">HTTP-EQUIV</span>=<span class="string">&quot;Cache-Control&quot;</span> <span class="attr">CONTENT</span>=<span class="string">&quot;no-cache&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">META</span> <span class="attr">HTTP-EQUIV</span>=<span class="string">&quot;Expires&quot;</span> <span class="attr">CONTENT</span>=<span class="string">&quot;0&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">HEAD</span>&gt;</span></span><br></pre></td></tr></table></figure><p>浏览器不会缓存html，但是还是会对重定向缓存并且这种方式并不规范，可能有的浏览器不支持。</p><h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><ol><li>对hash过的静态文件还是采用默认方式，客户端会缓存。</li><li>对html文件，返回时增加头：Cache-Control，必须每次来服务端校验，根据 <code>ETAG</code> 返回200或者304</li></ol><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 前端html文件</span></span><br><span class="line">    location / &#123;</span><br><span class="line">        add_header Cache-Control <span class="string">&#x27;no-cache, must-revalidate, proxy-revalidate, max-age=0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        root <span class="regexp">/var/</span>www<span class="regexp">/example/</span>dist/;</span><br><span class="line">        index index.html index.htm;</span><br><span class="line">        try_files <span class="variable">$uri</span> /index.html;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><div class="story post-story"><blockquote><ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/ETag">ETAG - MDN</a></li><li><a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.9">Cache-Control - RFC2616</a></li></ul></blockquote></div>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;问题&quot;&gt;&lt;a href=&quot;#问题&quot; class=&quot;headerlink&quot; title=&quot;问题&quot;&gt;&lt;/a&gt;问题&lt;/h2&gt;&lt;p&gt;单页面应用在重新部署更新时，此时正在浏览网页，并且已经在网页内的用户，始终会使用老的js与css文件，一直在使用已经缓存了的静态资源。&lt;/p&gt;</summary>
    
    
    
    <category term="技术" scheme="https://luanxu.me/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="前端" scheme="https://luanxu.me/categories/%E6%8A%80%E6%9C%AF/%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="SPA" scheme="https://luanxu.me/tags/SPA/"/>
    
    <category term="前端缓存" scheme="https://luanxu.me/tags/%E5%89%8D%E7%AB%AF%E7%BC%93%E5%AD%98/"/>
    
    <category term="前端优化" scheme="https://luanxu.me/tags/%E5%89%8D%E7%AB%AF%E4%BC%98%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>Go IOC 依赖注入 Dig|Wire|Inject</title>
    <link href="https://luanxu.me/posts/2454711668/"/>
    <id>https://luanxu.me/posts/2454711668/</id>
    <published>2021-09-09T01:28:30.000Z</published>
    <updated>2021-11-12T03:29:44.230Z</updated>
    
    <content type="html"><![CDATA[<h2 id="什么是控制反转-IOC"><a href="#什么是控制反转-IOC" class="headerlink" title="什么是控制反转(IOC)?"></a>什么是控制反转(IOC)?</h2><div class="story post-story"><p>Inversion of Control (IoC) 是面向对象编程中的一种设计原则，可以用来减低计算机代码之间的耦合度。其中最常见的方式叫做依赖注入（Dependency Injection，简称DI），还有一种方式叫“依赖查找”（Dependency Lookup）</p><span id="more"></span><p>用大白话说就是你想实例化一个对象，但是这个对象又层层依赖其他对象，原本你需要由自己一个个去处理好这些对象间的依赖关系，现在可以解放双手交给IOC框架自己去处理了，不需要自己每次都去写实例化部分的代码了</p></div><h2 id="无IOC的例子"><a href="#无IOC的例子" class="headerlink" title="无IOC的例子"></a>无IOC的例子</h2><div class="story post-story"><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;gorm.io/driver/mysql&quot;</span></span><br><span class="line"><span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MysqlConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">Dsn     <span class="keyword">string</span></span><br><span class="line">MaxIdle <span class="keyword">int</span></span><br><span class="line">MaxOpen <span class="keyword">int</span></span><br><span class="line">MaxLife <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> DataSourceType <span class="keyword">struct</span> &#123;</span><br><span class="line">DB *gorm.DB</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> DataSource *DataSourceType</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// no ioc</span></span><br><span class="line">mysqlConfig := &amp;MysqlConfig&#123;</span><br><span class="line">Dsn: <span class="string">&quot;dsn&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line">gormDb, err := gorm.Open(mysql.New(mysql.Config&#123;</span><br><span class="line">DSN: mysqlConfig.Dsn,</span><br><span class="line">&#125;), &amp;gorm.Config&#123;SkipDefaultTransaction: <span class="literal">true</span>&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Errorf(<span class="string">&quot;Db init error : %s&quot;</span>, err.Error())</span><br><span class="line">&#125;</span><br><span class="line">DataSource = &amp;DataSourceType&#123;</span><br><span class="line">DB: gormDb,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> userCount <span class="keyword">int64</span></span><br><span class="line"><span class="keyword">if</span> err := DataSource.DB.Table(<span class="string">&quot;user&quot;</span>).Count(&amp;userCount).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;User count error&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;no ioc User count: %v&quot;</span>, userCount)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ go <span class="builtin-name">run</span> ioc.go</span><br><span class="line"><span class="literal">no</span> ioc<span class="built_in"> User </span>count: 12</span><br></pre></td></tr></table></figure></div><h2 id="Uber-go-Dig"><a href="#Uber-go-Dig" class="headerlink" title="Uber-go/Dig"></a>Uber-go/Dig</h2><div class="story post-story"><p>Uber-go/dig 是一个基于反射的 Go 依赖注入工具包。</p><h3 id="参考代码"><a href="#参考代码" class="headerlink" title="参考代码"></a>参考代码</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;go.uber.org/dig&quot;</span></span><br><span class="line"><span class="string">&quot;gorm.io/driver/mysql&quot;</span></span><br><span class="line"><span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MysqlConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">Dsn     <span class="keyword">string</span></span><br><span class="line">MaxIdle <span class="keyword">int</span></span><br><span class="line">MaxOpen <span class="keyword">int</span></span><br><span class="line">MaxLife <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> DataSourceType <span class="keyword">struct</span> &#123;</span><br><span class="line">DB *gorm.DB</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> DataSource *DataSourceType</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">mysqlConfig := &amp;MysqlConfig&#123;</span><br><span class="line">Dsn: <span class="string">&quot;dsn&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// uber-go/dig  Constructors for different types are added to the container by using the Provide method.</span></span><br><span class="line">c := dig.New()</span><br><span class="line"><span class="keyword">if</span> err := c.Provide(<span class="function"><span class="keyword">func</span><span class="params">()</span> *<span class="title">MysqlConfig</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> mysqlConfig</span><br><span class="line">&#125;); err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;Provide error : %s&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err := c.Provide(<span class="function"><span class="keyword">func</span><span class="params">(mconfig *MysqlConfig)</span> <span class="params">(*gorm.DB, error)</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> gorm.Open(mysql.New(mysql.Config&#123;</span><br><span class="line">DSN: mconfig.Dsn,</span><br><span class="line">&#125;), &amp;gorm.Config&#123;SkipDefaultTransaction: <span class="literal">true</span>&#125;)</span><br><span class="line">&#125;); err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;Provide error : %s&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// using *gorm.DB from container</span></span><br><span class="line"><span class="keyword">if</span> err := c.Invoke(<span class="function"><span class="keyword">func</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">DataSource = &amp;DataSourceType&#123;</span><br><span class="line">DB: db,</span><br><span class="line">&#125;</span><br><span class="line">&#125;); err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;Provide error : %s&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> userCount <span class="keyword">int64</span></span><br><span class="line"><span class="keyword">if</span> err := DataSource.DB.Table(<span class="string">&quot;user&quot;</span>).Count(&amp;userCount).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;User count error&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;uber-go/dig User count: %v&quot;</span>, userCount)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="运行结果-1"><a href="#运行结果-1" class="headerlink" title="运行结果"></a>运行结果</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">go</span> run ioc.<span class="keyword">go</span></span><br><span class="line">uber-<span class="keyword">go</span>/<span class="keyword">dig</span> User coun<span class="variable">t:</span> <span class="number">12</span></span><br></pre></td></tr></table></figure></div><h2 id="以下内容正在施工中"><a href="#以下内容正在施工中" class="headerlink" title="以下内容正在施工中"></a>以下内容正在施工中</h2><div class="story post-story"><h2 id="google-wire"><a href="#google-wire" class="headerlink" title="google/wire"></a>google/wire</h2><h2 id="facebook-go-inject"><a href="#facebook-go-inject" class="headerlink" title="facebook-go/inject"></a>facebook-go/inject</h2><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><blockquote><ul><li><a href="https://github.com/uber-go/dig">uber-go/dig</a></li><li><a href="https://github.com/google/wire">google/wire</a></li><li><a href="https://github.com/facebook-go/inject">facebook-go/inject</a></li></ul></blockquote></div>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;什么是控制反转-IOC&quot;&gt;&lt;a href=&quot;#什么是控制反转-IOC&quot; class=&quot;headerlink&quot; title=&quot;什么是控制反转(IOC)?&quot;&gt;&lt;/a&gt;什么是控制反转(IOC)?&lt;/h2&gt;&lt;p&gt;Inversion of Control (IoC) 是面向对象编程中的一种设计原则，可以用来减低计算机代码之间的耦合度。其中最常见的方式叫做依赖注入（Dependency Injection，简称DI），还有一种方式叫“依赖查找”（Dependency Lookup）&lt;/p&gt;</summary>
    
    
    
    <category term="技术" scheme="https://luanxu.me/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="后端" scheme="https://luanxu.me/categories/%E6%8A%80%E6%9C%AF/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="Golang" scheme="https://luanxu.me/categories/%E6%8A%80%E6%9C%AF/%E5%90%8E%E7%AB%AF/Golang/"/>
    
    
    <category term="IOC" scheme="https://luanxu.me/tags/IOC/"/>
    
    <category term="Di" scheme="https://luanxu.me/tags/Di/"/>
    
    <category term="Dig" scheme="https://luanxu.me/tags/Dig/"/>
    
    <category term="Wire" scheme="https://luanxu.me/tags/Wire/"/>
    
    <category term="Inject" scheme="https://luanxu.me/tags/Inject/"/>
    
  </entry>
  
  <entry>
    <title>让前端自定义查询条件和分页</title>
    <link href="https://luanxu.me/posts/3693711526/"/>
    <id>https://luanxu.me/posts/3693711526/</id>
    <published>2021-08-31T13:52:53.000Z</published>
    <updated>2021-11-12T03:29:44.230Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h2><div class="story post-story"><p>作为一名后端在做Web后端业务开发时，都应该遵循以下规则</p><ul><li>降低代码耦合度</li><li>尽量避免代码冗余</li></ul><span id="more"></span><p>在使用RESTFUL API风格开发时，几乎所有方法为 <code>GET</code> 的 <strong>列表或详情</strong> 接口</p><p>都不可避免的需要用到 <code>分页</code>、<code>查询筛选条件</code>、<code>自定义排序</code> 的功能</p><p>假如我们为每个接口去分别开发以上三种功能，将会耗费大量时间</p><hr></div><h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><div class="story post-story"><ul><li>相同的功能，代码相似度高</li><li>当后端开发完成后，需要修改<code>查询筛选条件</code>时，前端无法及时反馈，需要等后端发布测试</li></ul><hr></div><h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><div class="story post-story"><p>很多后端都会将 <code>查询筛选条件</code> 、 <code>自定义排序</code> 做成参数查询</p><p>但是 <code>查询筛选条件</code> 则要一个个写接收请求参数并且去调用 <em><strong>where/orwhere/like/where in…</strong></em> 等方法去挨个处理</p><p>那要如何把选择权和控制权交给前端同事呢？<br>我们可以给所有接口<strong>获取列表</strong>的封装个方法</p><p>在这里使用的是 <code>Gin</code>+<code>Gorm</code> 的例子，其他框架也可以使用类似操作解决这样的问题</p><hr><h3 id="自定义分页"><a href="#自定义分页" class="headerlink" title="自定义分页"></a>自定义分页</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Paging</span><span class="params">(c *gin.Context, db *gorm.DB)</span> <span class="params">(db *gorm.DB, err error)</span></span> &#123;</span><br><span class="line">limitStr := c.Request.FormValue(<span class="string">&quot;limit&quot;</span>)</span><br><span class="line">    pageStr := c.Request.FormValue(<span class="string">&quot;page&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> limitStr == <span class="string">&quot;&quot;</span> || pageStr == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line"><span class="keyword">return</span> db, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">    limit, err := strconv.Atoi(limitStr)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> db, <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    page, err := strconv.Atoi(pageStr)</span><br><span class="line">     <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> db, <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    db = db.Offset((page - <span class="number">1</span>) * limit).Limit(limit)</span><br><span class="line"><span class="keyword">return</span> db, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="自定义排序"><a href="#自定义排序" class="headerlink" title="自定义排序"></a>自定义排序</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sort</span><span class="params">(c *gin.Context, db *gorm.DB)</span> *<span class="title">gorm</span>.<span class="title">DB</span></span> &#123;</span><br><span class="line">orderBy := c.Request.FormValue(<span class="string">&quot;order_by&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> orderBy == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> db</span><br><span class="line">    &#125;</span><br><span class="line">    order := c.Request.FormValue(<span class="string">&quot;order&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> order != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        db = db.Order(orderBy + <span class="string">&quot; &quot;</span> + order)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        db = db.Order(orderBy + <span class="string">&quot; DESC&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">return</span> db</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="自定义查询筛选条件"><a href="#自定义查询筛选条件" class="headerlink" title="自定义查询筛选条件"></a>自定义查询筛选条件</h3><p>分页和自定义排序功能就不做解释了，做过web后端基本都了解了</p><p><code>按照field_查询操作符_字段名的格式前端请求的query参数中提取并添加查询条件</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 按照field_查询操作符_字段名的格式前端请求的query参数中提取并添加查询条件</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ConditionSupport</span><span class="params">(c *gin.Context, db *gorm.DB)</span> <span class="params">(*gorm.DB, error)</span></span> &#123;</span><br><span class="line">query, err := url.ParseQuery(c.Request.URL.RawQuery)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;请求参数不正确，请联系管理员进行处理&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">// 找出所有带有field开头的，并且字符串长度大于9的query参数</span></span><br><span class="line"><span class="keyword">for</span> name, value := <span class="keyword">range</span> query &#123;</span><br><span class="line">        <span class="keyword">if</span> !strings.HasPrfix(name, <span class="string">&quot;field&quot;</span>) || <span class="built_in">len</span>(name) &lt;= <span class="number">9</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> db,<span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 给字段添加反引号，避免关键字等</span></span><br><span class="line">        fieldName := <span class="string">&quot;`&quot;</span> + name[<span class="number">9</span>:] + <span class="string">&quot;`&quot;</span></span><br><span class="line">        <span class="comment">// 联表字段处理 例如  `user`.`id`</span></span><br><span class="line">        fieldName = strings.Replace(fieldName,<span class="string">&quot;.&quot;</span>,<span class="string">&quot;`.`&quot;</span>,<span class="number">-1</span>)</span><br><span class="line">        <span class="comment">//取出操作符</span></span><br><span class="line">        opt := name[<span class="number">6</span>:<span class="number">8</span>]</span><br><span class="line">        <span class="keyword">switch</span> opt &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;eq&quot;</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(value) == <span class="number">1</span> &#123;</span><br><span class="line">                db = db.Where(fieldName+<span class="string">&quot;=?&quot;</span>, value[<span class="number">0</span>])</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                db = db.Where(fieldName+<span class="string">&quot; IN (?)&quot;</span>, value)</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;ne&quot;</span>:</span><br><span class="line">            db = db.Where(fieldName+<span class="string">&quot;&lt;&gt;?&quot;</span>, value[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;lt&quot;</span>:</span><br><span class="line">            db = db.Where(fieldName+<span class="string">&quot;&lt;?&quot;</span>, value[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;le&quot;</span>:</span><br><span class="line">            db = db.Where(fieldName+<span class="string">&quot;&lt;=?&quot;</span>, value[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;gt&quot;</span>:</span><br><span class="line">            db = db.Where(fieldName+<span class="string">&quot;&gt;?&quot;</span>, value[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;ge&quot;</span>:</span><br><span class="line">            db = db.Where(fieldName+<span class="string">&quot;&gt;=?&quot;</span>, value[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;lk&quot;</span>:</span><br><span class="line">            db = db.Where(fieldName+<span class="string">&quot; LIKE ?&quot;</span>, <span class="string">&quot;%&quot;</span>+value[<span class="number">0</span>]+<span class="string">&quot;%&quot;</span>)</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;re&quot;</span>:</span><br><span class="line">            db = db.Where(fieldName+<span class="string">&quot; REGEXP ?&quot;</span>, value[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;不支持的条件查询操作&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> db, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="结合三种方法一起使用"><a href="#结合三种方法一起使用" class="headerlink" title="结合三种方法一起使用"></a>结合三种方法一起使用</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Find</span><span class="params">(c *gin.Context, db *gorm.DB, result *<span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(<span class="keyword">int64</span>, error)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> count <span class="keyword">int64</span></span><br><span class="line">err := c.Request.ParseForm()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">&quot;参数不正确&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">// 添加自定义查询条件</span></span><br><span class="line">db, err = ConditionSupport(c, db)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">&quot;查询条件有误&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">// 添加分页支持</span></span><br><span class="line">db, err = Paging(c, db)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">&quot;分页参数不正确&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">err = db.Count(&amp;count).Error</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">&quot;数据库记录统计失败，请稍后再试&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">// 添加自定义排序</span></span><br><span class="line">err = Sort(c, db).Find(result).Error</span><br><span class="line"><span class="keyword">return</span> count, errors.New(<span class="string">&quot;数据库记录查询失败，请稍后再试&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后我们只需要给每个需要 <code>分页</code>、<code>查询筛选条件</code>、<code>自定义排序</code> 的地方使用Find函数便可以将操作权交给前端了</p></div>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求分析&quot;&gt;&lt;a href=&quot;#需求分析&quot; class=&quot;headerlink&quot; title=&quot;需求分析&quot;&gt;&lt;/a&gt;需求分析&lt;/h2&gt;&lt;p&gt;作为一名后端在做Web后端业务开发时，都应该遵循以下规则&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;降低代码耦合度&lt;/li&gt;
&lt;li&gt;尽量避免代码冗余&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://luanxu.me/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="后端" scheme="https://luanxu.me/categories/%E6%8A%80%E6%9C%AF/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="Golang" scheme="https://luanxu.me/categories/%E6%8A%80%E6%9C%AF/%E5%90%8E%E7%AB%AF/Golang/"/>
    
    
    <category term="Gorm" scheme="https://luanxu.me/tags/Gorm/"/>
    
    <category term="Gin" scheme="https://luanxu.me/tags/Gin/"/>
    
    <category term="Full Stack" scheme="https://luanxu.me/tags/Full-Stack/"/>
    
  </entry>
  
  <entry>
    <title>JSON.stringify中的replacer</title>
    <link href="https://luanxu.me/posts/1232104679/"/>
    <id>https://luanxu.me/posts/1232104679/</id>
    <published>2021-08-25T05:00:32.000Z</published>
    <updated>2021-10-09T02:15:21.626Z</updated>
    
    <content type="html"><![CDATA[<h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h2><div class="story post-story"><p>当我们在遇到需要深拷贝一个对象所有属性的时候<br>会想把关联的数据排除在外，例如这样的一个对象关联的send_by_user</p><p>当你的需求是修改这个庞大对象并且整体提交更新的时候会发现以下问题</p><ol><li>这个多余关联的对象不需要提交</li><li>发出请求的数据量变大</li></ol><span id="more"></span><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;id&quot;</span>: <span class="number">41</span>,</span><br><span class="line">    <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;消息标题&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;content&quot;</span>: <span class="string">&quot;消息内容&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;send_by&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">&quot;send_by_user&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;id&quot;</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;telephone&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;email&quot;</span>: <span class="string">&quot;10000@qq.com&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;department_id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;department_name&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;department&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;产品设计部&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;status&quot;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">&quot;created_at&quot;</span>: <span class="string">&quot;1970-01-01T08:00:00+08:00&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;updated_at&quot;</span>: <span class="string">&quot;2021-08-21T16:12:05+08:00&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;status&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;info&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;created_at&quot;</span>: <span class="string">&quot;1970-01-01T08:00:00+08:00&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;updated_at&quot;</span>: <span class="string">&quot;1970-01-01T08:00:00+08:00&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;send_to&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">&quot;status&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">&quot;created_at&quot;</span>: <span class="string">&quot;2021-08-21T16:55:53+08:00&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;deleted_at&quot;</span>: <span class="string">&quot;0001-01-01T00:00:00Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;updated_at&quot;</span>: <span class="string">&quot;2021-08-25T10:14:57+08:00&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><p>控制 JSON.stringify 序列化层级<br><code>JSON.stringify(value[, replacer [, space]])</code></p><p>使用JSON.stringify时传入第二个参数</p><ul><li>replacer 可选<br>如果该参数是一个函数，则在序列化过程中，被序列化的值的每个属性都会经过该函数的转换和处理；如果该参数是一个数组，则只有包含在这个数组中的属性名才会被序列化到最终的 JSON 字符串中；如果该参数为 null 或者未提供，则对象所有的属性都会被序列化。</li></ul><p>那我们只需要通过replacer传入函数过滤掉属性值是Object即可</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">JSON</span>.stringify(message,<span class="function">(<span class="params">k,v</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// k,v分别代表传入对象的属性名和属性值</span></span><br><span class="line">    <span class="comment">// 判断k是因为replace会传入一个 传入参数对象 的值,但是没有k, 我们直接返回即可</span></span><br><span class="line">    <span class="keyword">if</span>(!k) &#123;</span><br><span class="line">        <span class="keyword">return</span> v</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> v === <span class="string">&quot;object&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> v</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></div><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><div class="story post-story"><blockquote><ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify">MDN Web Docs</a></li></ul></blockquote></div>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;需求分析&quot;&gt;&lt;a href=&quot;#需求分析&quot; class=&quot;headerlink&quot; title=&quot;需求分析&quot;&gt;&lt;/a&gt;需求分析&lt;/h2&gt;&lt;p&gt;当我们在遇到需要深拷贝一个对象所有属性的时候&lt;br&gt;会想把关联的数据排除在外，例如这样的一个对象关联的send_by_user&lt;/p&gt;
&lt;p&gt;当你的需求是修改这个庞大对象并且整体提交更新的时候会发现以下问题&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;这个多余关联的对象不需要提交&lt;/li&gt;
&lt;li&gt;发出请求的数据量变大&lt;/li&gt;
&lt;/ol&gt;</summary>
    
    
    
    <category term="技术" scheme="https://luanxu.me/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="前端" scheme="https://luanxu.me/categories/%E6%8A%80%E6%9C%AF/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="JavaScript" scheme="https://luanxu.me/categories/%E6%8A%80%E6%9C%AF/%E5%89%8D%E7%AB%AF/JavaScript/"/>
    
    
  </entry>
  
</feed>
